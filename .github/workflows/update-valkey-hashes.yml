name: Commit new hash into valkey-hashes

on:
  workflow_call:
    inputs:
      version:
        description: The version of Valkey to create.
        type: string
        required: true
    secrets:
      PAT_TOKEN:
        description: PAT token for valkey-hashes repo.
        required: true

jobs:
  commit-hash:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^([0-9]+\.[0-9]+\.[0-9]+|unstable)$ ]]; then
            echo "Invalid version format. Expected format: x.y.z or 'unstable'"
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          repository: Autxmaton/valkey-hashes
          token: ${{ secrets.PAT_TOKEN }}

      - name: Update hash
        run: |
          VERSION=${{ inputs.version }}
          URL="https://github.com/Autxmaton/valkey/archive/refs/tags/${VERSION}.tar.gz"
          FILENAME="valkey-${VERSION}.tar.gz"
          wget -O $FILENAME $URL
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          HASH=$(sha256sum $FILENAME | cut -d ' ' -f 1)
          echo "hash $FILENAME sha256 $HASH $URL" >> README
          rm $FILENAME
          git commit -s -m "Add hash for ${VERSION}."
          git push


